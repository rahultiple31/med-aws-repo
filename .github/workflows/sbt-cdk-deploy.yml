name: Deploy SBT Infrastructure

on:
  workflow_dispatch:
    inputs:
      stack:
        description: "Choose which stack to deploy"
        required: true
        default: all-stacks
        type: choice
        options:
          - all-stacks
          - control-plane-stack.ts
          - application-plane-stack.ts
          - pipeline-plane-stack.ts

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      CDK_BOOTSTRAP_QUALIFIER: gha659fds
    defaults:
      run:
        working-directory: infrastructure

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Set up QEMU (arm64 emulation)
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Install infrastructure dependencies
        run: npm install

      - name: Ensure CDK bootstrap exists
        env:
          AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
          SBT_SYSTEM_ADMIN_EMAIL: ${{ secrets.SBT_SYSTEM_ADMIN_EMAIL }}
        run: |
          set -euo pipefail
          account_id="$(aws sts get-caller-identity --query Account --output text)"
          bootstrap_version_param="/cdk-bootstrap/${CDK_BOOTSTRAP_QUALIFIER}/version"

          if aws ssm get-parameter --name "$bootstrap_version_param" --region "$AWS_REGION" >/dev/null 2>&1; then
            echo "CDK bootstrap already exists in ${account_id}/${AWS_REGION} with qualifier ${CDK_BOOTSTRAP_QUALIFIER}"
          else
            echo "CDK bootstrap not found in ${account_id}/${AWS_REGION} with qualifier ${CDK_BOOTSTRAP_QUALIFIER}. Bootstrapping now..."
            npm run cdk -- bootstrap "aws://${account_id}/${AWS_REGION}" --require-approval never \
              --qualifier "${CDK_BOOTSTRAP_QUALIFIER}" \
              -c @aws-cdk/core:bootstrapQualifier="${CDK_BOOTSTRAP_QUALIFIER}" \
              -c systemAdminEmail="${SBT_SYSTEM_ADMIN_EMAIL:-bootstrap@example.com}"
          fi

      - name: Validate callback URL secret
        env:
          CONTROL_PLANE_CALLBACK_URL: ${{ secrets.CONTROL_PLANE_CALLBACK_URL }}
        run: |
          if [ -z "$CONTROL_PLANE_CALLBACK_URL" ]; then
            echo "Missing required secret: CONTROL_PLANE_CALLBACK_URL"
            exit 1
          fi

          case "$CONTROL_PLANE_CALLBACK_URL" in
            http://*|https://*)
              ;;
            *)
              echo "CONTROL_PLANE_CALLBACK_URL must start with http:// or https://"
              exit 1
              ;;
          esac

      - name: Resolve selected stack
        id: resolve_stack
        env:
          STACK_CHOICE: ${{ github.event.inputs.stack }}
        run: |
          stack_choice="${STACK_CHOICE:-all-stacks}"
          resolved_stack="--all"

          case "$stack_choice" in
            control-plane-stack.ts)
              resolved_stack="SbtControlPlaneStack"
              ;;
            application-plane-stack.ts)
              resolved_stack="SbtApplicationPlaneStack"
              ;;
            pipeline-plane-stack.ts)
              resolved_stack="SbtCiCdPipelineStack"
              ;;
            all-stacks)
              resolved_stack="--all"
              ;;
            *)
              echo "Unsupported stack choice: $stack_choice"
              exit 1
              ;;
          esac

          echo "Resolved stack target: $resolved_stack"
          echo "stack_name=$resolved_stack" >> "$GITHUB_OUTPUT"

      - name: CDK Synth
        env:
          SBT_SYSTEM_ADMIN_EMAIL: ${{ secrets.SBT_SYSTEM_ADMIN_EMAIL }}
          CONTROL_PLANE_CALLBACK_URL: ${{ secrets.CONTROL_PLANE_CALLBACK_URL }}
        run: >
          npm run cdk -- synth ${{ steps.resolve_stack.outputs.stack_name }}
          -c @aws-cdk/core:bootstrapQualifier="$CDK_BOOTSTRAP_QUALIFIER"
          -c systemAdminEmail="$SBT_SYSTEM_ADMIN_EMAIL"
          -c controlPlaneCallbackUrl="$CONTROL_PLANE_CALLBACK_URL"
          -c githubOwner="rahultiple31"
          -c githubRepo="cdk-web"
          -c githubBranch="main"


      - name: CDK Deploy
        env:
          SBT_SYSTEM_ADMIN_EMAIL: ${{ secrets.SBT_SYSTEM_ADMIN_EMAIL }}
          CONTROL_PLANE_CALLBACK_URL: ${{ secrets.CONTROL_PLANE_CALLBACK_URL }}
        run: >
          npm run cdk -- deploy ${{ steps.resolve_stack.outputs.stack_name }}
          --require-approval never
          -c @aws-cdk/core:bootstrapQualifier="$CDK_BOOTSTRAP_QUALIFIER"
          -c systemAdminEmail="$SBT_SYSTEM_ADMIN_EMAIL"
          -c controlPlaneCallbackUrl="$CONTROL_PLANE_CALLBACK_URL"
          -c githubOwner="rahultiple31"
          -c githubRepo="cdk-web"
          -c githubBranch="main"

