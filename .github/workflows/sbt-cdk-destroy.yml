name: Destroy SBT Infrastructure

on:
  workflow_dispatch:
    inputs:
      stack:
        description: "Choose which stack to destroy"
        required: true
        default: all-stacks
        type: choice
        options:
          - all-stacks
          - control-plane-stack.ts
          - application-plane-stack.ts
          - pipeline-plane-stack.ts
      confirm:
        description: "Type DESTROY to confirm"
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  destroy:
    runs-on: ubuntu-latest
    env:
      CDK_BOOTSTRAP_QUALIFIER: gha659fds
    defaults:
      run:
        working-directory: infrastructure

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Set up QEMU (arm64 emulation)
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: Install infrastructure dependencies
        run: npm install

      - name: Validate callback URL secret
        env:
          CONTROL_PLANE_CALLBACK_URL: ${{ secrets.CONTROL_PLANE_CALLBACK_URL }}
        run: |
          if [ -z "$CONTROL_PLANE_CALLBACK_URL" ]; then
            echo "Missing required secret: CONTROL_PLANE_CALLBACK_URL"
            exit 1
          fi

          case "$CONTROL_PLANE_CALLBACK_URL" in
            http://*|https://*)
              ;;
            *)
              echo "CONTROL_PLANE_CALLBACK_URL must start with http:// or https://"
              exit 1
              ;;
          esac

      - name: Confirm destroy request
        env:
          CONFIRM: ${{ github.event.inputs.confirm }}
        run: |
          if [ "$CONFIRM" != "DESTROY" ]; then
            echo "Confirmation failed. Enter DESTROY in the 'confirm' input."
            exit 1
          fi

      - name: CDK Destroy
        env:
          STACK_CHOICE: ${{ github.event.inputs.stack }}
          SBT_SYSTEM_ADMIN_EMAIL: ${{ secrets.SBT_SYSTEM_ADMIN_EMAIL }}
          CODESTAR_CONNECTION_ARN: ${{ secrets.CODESTAR_CONNECTION_ARN }}
          CONTROL_PLANE_CALLBACK_URL: ${{ secrets.CONTROL_PLANE_CALLBACK_URL }}
        run: |
          set -euo pipefail

          disable_rds_deletion_protection_if_needed() {
            local stack_name="$1"
            if [ "$stack_name" != "SbtApplicationPlaneStack" ]; then
              return 0
            fi

            echo "Checking RDS deletion protection for ${stack_name}"

            if ! aws cloudformation describe-stacks --stack-name "$stack_name" >/dev/null 2>&1; then
              echo "Stack ${stack_name} not found; skipping RDS deletion protection checks."
              return 0
            fi

            local db_instance_ids
            db_instance_ids="$(aws cloudformation list-stack-resources \
              --stack-name "$stack_name" \
              --query "StackResourceSummaries[?ResourceType=='AWS::RDS::DBInstance'].PhysicalResourceId" \
              --output text)"

            if [ -z "$db_instance_ids" ] || [ "$db_instance_ids" = "None" ]; then
              echo "No RDS DB instances found in ${stack_name}; continuing."
              return 0
            fi

            for db_instance_id in $db_instance_ids; do
              echo "Inspecting RDS instance ${db_instance_id}"
              local deletion_protection
              deletion_protection="$(aws rds describe-db-instances \
                --db-instance-identifier "$db_instance_id" \
                --query "DBInstances[0].DeletionProtection" \
                --output text)"

              if [ "$deletion_protection" = "True" ]; then
                echo "Disabling deletion protection on RDS instance ${db_instance_id}"
                aws rds modify-db-instance \
                  --db-instance-identifier "$db_instance_id" \
                  --no-deletion-protection \
                  --apply-immediately >/dev/null

                echo "Waiting for RDS instance ${db_instance_id} to become available"
                aws rds wait db-instance-available --db-instance-identifier "$db_instance_id"
              else
                echo "Deletion protection already disabled on ${db_instance_id}."
              fi
            done
          }

          destroy_stack() {
            local stack_name="$1"
            echo "Destroying ${stack_name}"
            disable_rds_deletion_protection_if_needed "$stack_name"
            npm run cdk -- destroy "${stack_name}" --force \
              -c @aws-cdk/core:bootstrapQualifier="$CDK_BOOTSTRAP_QUALIFIER" \
              -c systemAdminEmail="$SBT_SYSTEM_ADMIN_EMAIL" \
              -c controlPlaneCallbackUrl="$CONTROL_PLANE_CALLBACK_URL" \
              -c githubOwner="rahultiple31" \
              -c githubRepo="cdk-web" \
              -c githubBranch="main" \
              -c codestarConnectionArn="$CODESTAR_CONNECTION_ARN"
          }

          case "$STACK_CHOICE" in
            control-plane-stack.ts)
              destroy_stack "SbtControlPlaneStack"
              ;;
            application-plane-stack.ts)
              destroy_stack "SbtApplicationPlaneStack"
              ;;
            pipeline-plane-stack.ts)
              destroy_stack "SbtCiCdPipelineStack"
              ;;
            all-stacks)
              destroy_stack "SbtCiCdPipelineStack"
              destroy_stack "SbtApplicationPlaneStack"
              destroy_stack "SbtControlPlaneStack"
              ;;
            *)
              echo "Unsupported stack choice: $STACK_CHOICE"
              exit 1
              ;;
          esac
